<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestor de Cartão</title>
    
    <!-- PWA Meta Tags Essenciais -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Finanças">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/96/credit-card-front.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { primary: '#4F46E5', secondary: '#10B981', dark: '#1F2937' }
                }
            }
        }
    </script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
    
    <div id="app" v-cloak class="h-screen flex flex-col overflow-hidden">
        
        <!-- TELA DE LOGIN -->
        <div v-if="!user" class="absolute inset-0 z-50 bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
                <div class="bg-primary/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="lock" class="w-10 h-10 text-primary"></i>
                </div>
                <h1 class="text-2xl font-bold mb-2">Login Seguro</h1>
                <p class="text-gray-500 mb-8 text-sm">Faça login para sincronizar e proteger seus gastos.</p>
                
                <button @click="loginWithGoogle" class="w-full bg-white border border-gray-300 dark:border-gray-600 dark:bg-gray-700 hover:bg-gray-50 text-gray-800 dark:text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-3 transition shadow-sm">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                    Entrar com Google
                </button>
            </div>
        </div>

        <!-- APP PRINCIPAL -->
        <template v-else>
            <!-- Header -->
            <header class="bg-white dark:bg-gray-800 shadow-sm z-10 p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2">
                    <img :src="user.photoURL" class="w-8 h-8 rounded-full border border-gray-200">
                    <h1 class="font-bold text-sm truncate max-w-[150px]">Olá, {{ user.displayName.split(' ')[0] }}</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button @click="toggleDarkMode" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i :data-lucide="isDark ? 'sun' : 'moon'" class="w-5 h-5"></i>
                    </button>
                    <button @click="logout" class="text-red-500 text-xs font-bold">Sair</button>
                </div>
            </header>

            <!-- Seletor de Mês -->
            <div v-if="currentTab === 'home'" class="bg-primary text-white p-4 shadow-md shrink-0">
                <div class="flex justify-between items-center mb-2">
                    <button @click="changeMonth(-1)" class="p-1"><i data-lucide="chevron-left"></i></button>
                    <span class="font-bold text-lg capitalize">{{ formattedCurrentMonth }}</span>
                    <button @click="changeMonth(1)" class="p-1"><i data-lucide="chevron-right"></i></button>
                </div>
                <div class="flex justify-between text-sm opacity-90">
                    <span>Total: {{ formatCurrency(monthlyTotals.total) }}</span>
                    <span>Meu: {{ formatCurrency(monthlyTotals.mine) }}</span>
                </div>
            </div>

            <!-- Conteúdo Principal -->
            <main class="flex-1 overflow-y-auto p-4 pb-24 relative">
                
                <!-- VIEW: HOME (Lista de Gastos) -->
                <div v-if="currentTab === 'home'" class="space-y-4">
                    <div v-if="loading" class="text-center py-10 opacity-50">
                        <i data-lucide="loader-2" class="w-8 h-8 mx-auto animate-spin"></i>
                        <p class="text-xs mt-2">Sincronizando...</p>
                    </div>

                    <div v-else-if="expensesForMonth.length === 0" class="text-center py-10 text-gray-500">
                        <i data-lucide="shopping-bag" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>Nenhum gasto neste mês.</p>
                    </div>

                    <!-- Lista de Gastos Agrupada -->
                    <div v-for="(group, personId) in groupedExpenses" :key="personId" class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden animate-fade-in">
                        <div class="p-3 bg-gray-100 dark:bg-gray-700 flex justify-between items-center border-l-4" :style="{ borderLeftColor: getPersonColor(personId) }">
                            <span class="font-bold">{{ getPersonName(personId) }}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold">{{ formatCurrency(group.total) }}</span>
                                <button v-if="personId !== 'eu'" @click="shareOnWhatsapp(personId, group.items)" class="text-green-500 hover:text-green-600">
                                    <i data-lucide="share-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="divide-y divide-gray-100 dark:divide-gray-700">
                            <div v-for="expense in group.items" :key="expense.id" @click="editExpense(expense)" class="p-3 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                                <div>
                                    <div class="font-medium">{{ expense.description }}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
                                        <span class="bg-gray-200 dark:bg-gray-600 px-1.5 rounded text-[10px]">{{ getCardName(expense.cardId) }}</span>
                                        <span>{{ expense.category }}</span>
                                        <span v-if="expense.installments > 1" class="text-blue-500 font-bold">
                                            ({{ expense.currentInstallment }}/{{ expense.installments }})
                                        </span>
                                        <span v-if="expense.isRecurring" class="text-purple-500 font-bold">
                                            <i data-lucide="repeat" class="w-3 h-3 inline"></i>
                                        </span>
                                    </div>
                                </div>
                                <span class="font-bold text-gray-700 dark:text-gray-200">{{ formatCurrency(expense.amount) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: CONFIGURAÇÕES -->
                <div v-if="currentTab === 'settings'" class="space-y-6">
                    <!-- Cartões -->
                    <section>
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="font-bold text-lg">Cartões</h2>
                            <button @click="openModal('card')" class="text-primary text-sm font-bold">+ Adicionar</button>
                        </div>
                        <div class="grid gap-2">
                            <div v-for="card in cards" :key="card.id" class="bg-gradient-to-r from-gray-800 to-gray-700 text-white p-4 rounded-xl shadow-lg relative overflow-hidden">
                                <div class="flex justify-between items-start z-10 relative">
                                    <div>
                                        <h3 class="font-bold text-lg">{{ card.name }}</h3>
                                        <p class="text-xs opacity-75">Fecha dia {{ card.closingDay }} • Vence dia {{ card.dueDay }}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="prepareEditCard(card)" class="p-1"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                        <button @click="deleteItem('cards', card.id)" class="p-1 text-red-400"><i data-lucide="trash" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                <div class="mt-4 text-sm font-mono opacity-90">Limite: {{ formatCurrency(card.limit) }}</div>
                            </div>
                        </div>
                    </section>

                    <!-- Pessoas -->
                    <section>
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="font-bold text-lg">Pessoas</h2>
                            <button @click="openModal('person')" class="text-primary text-sm font-bold">+ Adicionar</button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <div v-for="person in people" :key="person.id" class="px-3 py-1 rounded-full text-white text-sm flex items-center gap-2" :style="{ backgroundColor: person.color }">
                                {{ person.name }}
                                <button v-if="person.id !== 'eu'" @click="deleteItem('people', person.id)" class="hover:text-red-200">×</button>
                            </div>
                        </div>
                    </section>

                    <!-- Categorias -->
                    <section>
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="font-bold text-lg">Categorias</h2>
                            <div class="flex gap-2">
                                <input v-model="newCategoryName" placeholder="Nova..." class="border rounded px-2 py-1 text-sm dark:bg-gray-800 dark:border-gray-600 w-full" @keyup.enter="addCategory">
                                <button @click="addCategory" class="text-primary font-bold text-lg px-2">+</button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <div v-for="(cat, index) in categories" :key="index" class="bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-lg text-sm flex items-center gap-2">
                                {{ cat }}
                                <button @click="deleteCategory(cat)" class="text-gray-500 hover:text-red-500">×</button>
                            </div>
                        </div>
                    </section>
                </div>
            </main>

            <!-- Menu Inferior -->
            <nav class="bg-white dark:bg-gray-800 shadow-[0_-2px_10px_rgba(0,0,0,0.1)] p-2 flex justify-around items-center shrink-0 z-20">
                <button @click="currentTab = 'home'" :class="currentTab === 'home' ? 'text-primary' : 'text-gray-400'" class="flex flex-col items-center p-2">
                    <i data-lucide="home" class="w-6 h-6"></i>
                    <span class="text-xs mt-1">Início</span>
                </button>
                <button @click="openModal('expense')" class="bg-primary text-white p-4 rounded-full -mt-8 shadow-lg border-4 border-gray-50 dark:border-gray-900 transform active:scale-95 transition">
                    <i data-lucide="plus" class="w-8 h-8"></i>
                </button>
                <button @click="currentTab = 'settings'" :class="currentTab === 'settings' ? 'text-primary' : 'text-gray-400'" class="flex flex-col items-center p-2">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                    <span class="text-xs mt-1">Ajustes</span>
                </button>
            </nav>
        </template>

        <!-- MODAL: Adicionar/Editar Despesa -->
        <div v-if="modals.expense" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-gray-800 w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-xl">{{ editingId ? 'Editar Compra' : 'Nova Compra' }}</h3>
                    <button @click="closeModals" class="text-gray-500"><i data-lucide="x"></i></button>
                </div>

                <div class="space-y-4">
                    <!-- Input Valor -->
                    <div>
                        <label class="text-xs text-gray-500 font-bold uppercase">Valor</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-gray-500">R$</span>
                            <input type="tel" v-model="expenseForm.displayAmount" @input="formatInputMoney" class="w-full bg-gray-100 dark:bg-gray-700 rounded-lg p-3 pl-10 text-xl font-bold focus:ring-2 ring-primary outline-none" placeholder="0,00">
                        </div>
                    </div>
                    <!-- Descrição -->
                    <div>
                        <label class="text-xs text-gray-500 font-bold uppercase">Descrição</label>
                        <input type="text" v-model="expenseForm.description" class="w-full bg-gray-100 dark:bg-gray-700 rounded-lg p-3 outline-none" placeholder="Ex: Mercado">
                    </div>
                    <!-- Data -->
                    <div>
                         <label class="text-xs text-gray-500 font-bold uppercase">Data da Compra</label>
                         <input type="date" v-model="expenseForm.date" class="w-full bg-gray-100 dark:bg-gray-700 rounded-lg p-3 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Cartão -->
                        <div>
                            <label class="text-xs text-gray-500 font-bold uppercase">Cartão</label>
                            <select v-model="expenseForm.cardId" class="w-full bg-gray-100 dark:bg-gray-700 rounded-lg p-3 outline-none appearance-none">
                                <option v-for="card in cards" :key="card.id" :value="card.id">{{ card.name }}</option>
                            </select>
                        </div>
                         <!-- Categoria -->
                         <div>
                            <label class="text-xs text-gray-500 font-bold uppercase">Categoria</label>
                            <select v-model="expenseForm.category" class="w-full bg-gray-100 dark:bg-gray-700 rounded-lg p-3 outline-none appearance-none">
                                <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Pessoa -->
                    <div>
                        <label class="text-xs text-gray-500 font-bold uppercase">Quem comprou?</label>
                        <div class="flex gap-2 overflow-x-auto py-2">
                            <button v-for="person in people" :key="person.id" 
                                @click="expenseForm.personId = person.id"
                                :class="expenseForm.personId === person.id ? 'ring-2 ring-offset-2 ring-primary scale-105' : 'opacity-70'"
                                :style="{ backgroundColor: person.color }"
                                class="px-4 py-2 rounded-full text-white text-sm font-bold whitespace-nowrap transition">
                                {{ person.name }}
                            </button>
                        </div>
                    </div>

                    <!-- Tipo -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                        <div class="flex gap-2 mb-3">
                            <button @click="expenseForm.type = 'avista'" :class="expenseForm.type === 'avista' ? 'bg-primary text-white shadow' : 'bg-white dark:bg-gray-600 text-gray-700 dark:text-gray-200'" class="flex-1 py-2 rounded-md text-sm font-medium transition">À vista</button>
                            <button @click="expenseForm.type = 'parcelado'" :class="expenseForm.type === 'parcelado' ? 'bg-primary text-white shadow' : 'bg-white dark:bg-gray-600 text-gray-700 dark:text-gray-200'" class="flex-1 py-2 rounded-md text-sm font-medium transition">Parcelado</button>
                            <button @click="expenseForm.type = 'assinatura'" :class="expenseForm.type === 'assinatura' ? 'bg-primary text-white shadow' : 'bg-white dark:bg-gray-600 text-gray-700 dark:text-gray-200'" class="flex-1 py-2 rounded-md text-sm font-medium transition">Fixo</button>
                        </div>

                        <div v-if="expenseForm.type === 'parcelado'" class="space-y-3">
                            <div class="flex items-center justify-between">
                                <label class="text-sm">Parcelas:</label>
                                <input type="number" v-model="expenseForm.installmentsCount" min="2" max="48" class="w-16 bg-white dark:bg-gray-600 rounded p-1 text-center font-bold">
                            </div>
                            <div class="flex gap-2 text-sm">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" v-model="expenseForm.amountType" value="total" class="text-primary focus:ring-primary">
                                    <span>Valor Total</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" v-model="expenseForm.amountType" value="parcela" class="text-primary focus:ring-primary">
                                    <span>Valor da Parcela</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-2">
                         <button v-if="editingId" @click="deleteCurrentExpense" class="flex-1 bg-red-100 text-red-600 font-bold py-3 rounded-xl hover:bg-red-200">Excluir</button>
                        <button @click="saveExpense" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl shadow-lg hover:bg-primary/90 transition flex justify-center">
                            <i v-if="saving" data-lucide="loader-2" class="animate-spin mr-2"></i>
                            {{ editingId ? 'Salvar' : 'Adicionar' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAIS AUXILIARES (Cartão, Pessoa) -->
        <div v-if="modals.card" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                <h3 class="font-bold text-lg mb-4">{{ cardForm.id ? 'Editar Cartão' : 'Novo Cartão' }}</h3>
                <div class="space-y-3">
                    <input v-model="cardForm.name" placeholder="Nome (ex: Nubank)" class="w-full border p-2 rounded dark:bg-gray-700 dark:border-gray-600">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs">Fechamento</label>
                            <input v-model="cardForm.closingDay" type="number" class="w-full border p-2 rounded dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        <div>
                            <label class="text-xs">Vencimento</label>
                            <input v-model="cardForm.dueDay" type="number" class="w-full border p-2 rounded dark:bg-gray-700 dark:border-gray-600">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs">Limite</label>
                        <input v-model="cardForm.limit" type="number" class="w-full border p-2 rounded dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button @click="closeModals" class="flex-1 bg-gray-200 dark:bg-gray-700 py-2 rounded">Cancelar</button>
                        <button @click="saveCard" class="flex-1 bg-primary text-white py-2 rounded">Salvar</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="modals.person" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                <h3 class="font-bold text-lg mb-4">Nova Pessoa</h3>
                <input v-model="newPersonName" placeholder="Nome da pessoa" class="w-full border p-2 rounded mb-4 dark:bg-gray-700 dark:border-gray-600">
                <div class="flex gap-2">
                    <button @click="closeModals" class="flex-1 bg-gray-200 dark:bg-gray-700 py-2 rounded">Cancelar</button>
                    <button @click="savePerson" class="flex-1 bg-primary text-white py-2 rounded">Salvar</button>
                </div>
            </div>
        </div>

    </div>

    <!-- MÓDULO JS COM FIREBASE + VUE -->
    <script type="module">
        import { createApp, ref, computed, onMounted, watch, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, where, writeBatch, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCXTOyZB5C-N8sbn1agcFQDK60dT-_Jebc",
            authDomain: "parcelados-9d216.firebaseapp.com",
            projectId: "parcelados-9d216",
            storageBucket: "parcelados-9d216.firebasestorage.app",
            messagingSenderId: "1017241443965",
            appId: "1:1017241443965:web:982f1f3bcd0f8489739b14"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        createApp({
            setup() {
                const user = ref(null);
                const loading = ref(true);
                const saving = ref(false);
                const isDark = ref(false);
                const currentTab = ref('home');
                const currentDate = ref(new Date());
                const modals = ref({ expense: false, card: false, person: false });
                const cards = ref([]);
                const people = ref([]);
                const categories = ref(['Alimentação', 'Transporte', 'Lazer', 'Casa', 'Saúde']);
                const expenses = ref([]);
                const newCategoryName = ref('');
                const newPersonName = ref('');
                const editingId = ref(null); 
                const expenseForm = ref({ amount: 0, displayAmount: '', description: '', date: new Date().toISOString().split('T')[0], cardId: '', personId: 'eu', category: '', type: 'avista', installmentsCount: 2, amountType: 'total' });
                const cardForm = ref({ id: null, name: '', closingDay: 1, dueDay: 10, limit: 0 });
                const colorPalette = ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#8B5CF6', '#EC4899'];

                onMounted(() => {
                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        if (u) {
                            initDataListeners(u.uid);
                            const theme = localStorage.getItem('theme');
                            if (theme === 'dark') isDark.value = true;
                        }
                        loading.value = false;
                        updateIcons();
                    });
                });

                const loginWithGoogle = async () => {
                    const provider = new GoogleAuthProvider();
                    try { await signInWithPopup(auth, provider); } 
                    catch (error) { alert("Erro ao logar: " + error.message); }
                };

                const logout = () => signOut(auth);

                let unsubscribeExpenses, unsubscribeCards, unsubscribePeople, unsubscribeCats;

                const initDataListeners = (uid) => {
                    unsubscribeCards = onSnapshot(collection(db, 'users', uid, 'cards'), (snap) => {
                        cards.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                    unsubscribePeople = onSnapshot(collection(db, 'users', uid, 'people'), (snap) => {
                        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        if(!list.find(p => p.id === 'eu')) {
                            setDoc(doc(db, 'users', uid, 'people', 'eu'), { name: 'Eu', color: '#4F46E5' });
                        }
                        people.value = list;
                    });
                    unsubscribeExpenses = onSnapshot(collection(db, 'users', uid, 'expenses'), (snap) => {
                        expenses.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                    unsubscribeCats = onSnapshot(doc(db, 'users', uid, 'config', 'categories'), (snap) => {
                        if(snap.exists()) categories.value = snap.data().list;
                        else setDoc(doc(db, 'users', uid, 'config', 'categories'), { list: categories.value });
                    });
                };

                const formattedCurrentMonth = computed(() => currentDate.value.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }));
                
                const expensesForMonth = computed(() => {
                    const targetMonth = currentDate.value.getMonth();
                    const targetYear = currentDate.value.getFullYear();
                    return expenses.value.filter(exp => {
                        if (exp.isRecurring) return true;
                        const expDate = new Date(exp.dueDate);
                        return expDate.getMonth() === targetMonth && expDate.getFullYear() === targetYear;
                    });
                });

                const groupedExpenses = computed(() => {
                    const groups = {};
                    people.value.forEach(p => { groups[p.id] = { total: 0, items: [] }; });
                    expensesForMonth.value.forEach(exp => {
                        if(groups[exp.personId]) {
                            groups[exp.personId].items.push(exp);
                            groups[exp.personId].total += exp.amount;
                        }
                    });
                    return groups;
                });

                const monthlyTotals = computed(() => {
                    let total = 0, mine = 0;
                    expensesForMonth.value.forEach(exp => {
                        total += exp.amount;
                        if(exp.personId === 'eu') mine += exp.amount;
                    });
                    return { total, mine };
                });

                const calculateDueDate = (purchaseDateStr, cardId) => {
                    const card = cards.value.find(c => c.id === cardId);
                    if (!card) return purchaseDateStr;
                    const purchaseDate = new Date(purchaseDateStr);
                    const closingDay = parseInt(card.closingDay);
                    const dueDay = parseInt(card.dueDay);
                    let referenceMonth;
                    if (purchaseDate.getDate() >= closingDay) {
                        referenceMonth = new Date(purchaseDate.getFullYear(), purchaseDate.getMonth() + 1, 1);
                    } else {
                        referenceMonth = new Date(purchaseDate.getFullYear(), purchaseDate.getMonth(), 1);
                    }
                    let billMonth = referenceMonth.getMonth();
                    let billYear = referenceMonth.getFullYear();
                    if (dueDay < closingDay) billMonth++; 
                    return new Date(billYear, billMonth, dueDay).toISOString().split('T')[0];
                };

                const saveExpense = async () => {
                    if (!expenseForm.value.amount || !expenseForm.value.cardId) return alert('Preencha dados');
                    saving.value = true;
                    const batch = writeBatch(db);
                    const uid = user.value.uid;
                    const groupId = editingId.value || doc(collection(db, 'users', uid, 'expenses')).id; 

                    if (editingId.value) {
                         const toDelete = expenses.value.filter(e => e.groupId === editingId.value);
                         toDelete.forEach(e => batch.delete(doc(db, 'users', uid, 'expenses', e.id)));
                    }

                    const baseExpense = {
                        description: expenseForm.value.description,
                        cardId: expenseForm.value.cardId,
                        personId: expenseForm.value.personId,
                        category: expenseForm.value.category,
                        groupId: groupId
                    };
                    const purchaseDate = expenseForm.value.date;

                    if (expenseForm.value.type === 'parcelado') {
                        const count = expenseForm.value.installmentsCount;
                        const val = expenseForm.value.amountType === 'total' ? expenseForm.value.amount / count : expenseForm.value.amount;
                        for (let i = 0; i < count; i++) {
                            let dateObj = new Date(purchaseDate);
                            dateObj.setMonth(dateObj.getMonth() + i);
                            const dateStr = dateObj.toISOString().split('T')[0];
                            const dueDate = calculateDueDate(dateStr, baseExpense.cardId);
                            const newRef = doc(collection(db, 'users', uid, 'expenses'));
                            batch.set(newRef, { ...baseExpense, amount: val, date: dateStr, dueDate: dueDate, installments: count, currentInstallment: i + 1, isRecurring: false });
                        }
                    } else if (expenseForm.value.type === 'assinatura') {
                        const newRef = doc(collection(db, 'users', uid, 'expenses'));
                        batch.set(newRef, { ...baseExpense, amount: expenseForm.value.amount, date: purchaseDate, dueDate: purchaseDate, installments: 1, isRecurring: true });
                    } else {
                        const dueDate = calculateDueDate(purchaseDate, baseExpense.cardId);
                        const newRef = doc(collection(db, 'users', uid, 'expenses'));
                        batch.set(newRef, { ...baseExpense, amount: expenseForm.value.amount, date: purchaseDate, dueDate: dueDate, installments: 1, currentInstallment: 1, isRecurring: false });
                    }
                    await batch.commit();
                    saving.value = false;
                    closeModals();
                };

                const deleteCurrentExpense = async () => {
                    if (!confirm('Apagar compra?')) return;
                    saving.value = true;
                    const batch = writeBatch(db);
                    const uid = user.value.uid;
                    const toDelete = expenses.value.filter(e => e.groupId === editingId.value);
                    toDelete.forEach(e => batch.delete(doc(db, 'users', uid, 'expenses', e.id)));
                    await batch.commit();
                    saving.value = false;
                    closeModals();
                };

                const saveCard = async () => {
                    const uid = user.value.uid;
                    const id = cardForm.value.id || doc(collection(db, 'users', uid, 'cards')).id;
                    await setDoc(doc(db, 'users', uid, 'cards', id), { ...cardForm.value });
                    closeModals();
                };
                
                const deleteItem = async (col, id) => {
                    if(!confirm('Tem certeza?')) return;
                    await deleteDoc(doc(db, 'users', user.value.uid, col, id));
                };

                const savePerson = async () => {
                    if (!newPersonName.value) return;
                    const uid = user.value.uid;
                    const color = colorPalette[(people.value.length - 1) % colorPalette.length];
                    const id = doc(collection(db, 'users', uid, 'people')).id;
                    await setDoc(doc(db, 'users', uid, 'people', id), { name: newPersonName.value, color: color });
                    newPersonName.value = '';
                    closeModals();
                };

                const addCategory = async () => {
                    if (newCategoryName.value && !categories.value.includes(newCategoryName.value)) {
                        const newList = [...categories.value, newCategoryName.value];
                        await setDoc(doc(db, 'users', user.value.uid, 'config', 'categories'), { list: newList });
                        newCategoryName.value = '';
                    }
                };

                const deleteCategory = async (catName) => {
                    const newList = categories.value.filter(c => c !== catName);
                    await setDoc(doc(db, 'users', user.value.uid, 'config', 'categories'), { list: newList });
                };

                const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
                const formatInputMoney = (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (!value) value = '0';
                    const floatVal = parseFloat(value) / 100;
                    expenseForm.value.amount = floatVal;
                    expenseForm.value.displayAmount = floatVal.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                };
                const toggleDarkMode = () => {
                    isDark.value = !isDark.value;
                    document.documentElement.classList.toggle('dark');
                    localStorage.setItem('theme', isDark.value ? 'dark' : 'light');
                };
                const changeMonth = (d) => {
                    const n = new Date(currentDate.value);
                    n.setMonth(n.getMonth() + d);
                    currentDate.value = n;
                };
                const updateIcons = () => nextTick(() => window.lucide && window.lucide.createIcons());
                
                const openModal = (name) => {
                    if (name === 'expense') {
                         expenseForm.value = { amount: 0, displayAmount: '', description: '', date: new Date().toISOString().split('T')[0], cardId: cards.value[0]?.id || '', personId: 'eu', category: categories.value[0] || '', type: 'avista', installmentsCount: 2, amountType: 'total' };
                        editingId.value = null;
                    }
                    if (name === 'card') cardForm.value = { id: null, name: '', closingDay: 1, dueDay: 10, limit: 1000 };
                    modals.value[name] = true;
                    updateIcons();
                };

                const prepareEditCard = (card) => { cardForm.value = { ...card }; modals.value.card = true; };
                const editExpense = (expense) => {
                    editingId.value = expense.groupId;
                    expenseForm.value = { ...expense, displayAmount: expense.amount.toLocaleString('pt-BR', { minimumFractionDigits: 2 }), type: expense.installments > 1 ? 'parcelado' : (expense.isRecurring ? 'assinatura' : 'avista'), installmentsCount: expense.installments || 1, amountType: 'parcela' };
                    if (expense.installments > 1) {
                         const group = expenses.value.filter(e => e.groupId === expense.groupId);
                         if(group.length) {
                             const first = group.reduce((p, c) => p.date < c.date ? p : c);
                             expenseForm.value.date = first.date;
                         }
                    }
                    modals.value.expense = true;
                };

                const closeModals = () => { Object.keys(modals.value).forEach(k => modals.value[k] = false); editingId.value = null; };
                const shareOnWhatsapp = (personId, items) => {
                    const person = people.value.find(p => p.id === personId);
                    let text = `*Fatura ${formattedCurrentMonth.value} - ${person.name}*\n\n`;
                    let total = 0;
                    items.forEach(item => {
                        let desc = item.description;
                        if(item.installments > 1) desc += ` (${item.currentInstallment}/${item.installments})`;
                        text += `${desc}: ${formatCurrency(item.amount)}\n`;
                        total += item.amount;
                    });
                    text += `\n*Total: ${formatCurrency(total)}*`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                };

                watch([currentTab, modals, user], updateIcons);
                const getPersonColor = (id) => people.value.find(p => p.id === id)?.color || '#ccc';
                const getPersonName = (id) => people.value.find(p => p.id === id)?.name || '???';
                const getCardName = (id) => cards.value.find(c => c.id === id)?.name || '???';

                return {
                    user, loginWithGoogle, logout, loading, saving, isDark, toggleDarkMode, currentTab, modals, openModal, closeModals,
                    cards, people, categories, expenses, formattedCurrentMonth, changeMonth, monthlyTotals, groupedExpenses,
                    expenseForm, cardForm, newPersonName, newCategoryName, saveExpense, saveCard, savePerson, addCategory, deleteCategory, deleteItem,
                    formatInputMoney, formatCurrency, getPersonColor, getPersonName, getCardName, prepareEditCard, editingId, deleteCurrentExpense, shareOnWhatsapp, expensesForMonth, editExpense
                };
            }
        }).mount('#app');
    </script>
    
    <!-- REGISTRO DO SW PARA PWA (Obrigatório) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                .then(registration => console.log('SW registrado com sucesso:', registration.scope))
                .catch(err => console.error('Falha ao registrar SW:', err));
            });
        }
    </script>
</body>
</html>
